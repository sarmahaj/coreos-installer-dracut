#!/bin/bash

set -euo pipefail
udevadm settle

lsblk_output=$(lsblk)
findmnt_output=$(findmnt)
blkid_output=$(blkid)
echo $lsblk_output
echo $findmnt_output
echo $blkid_output

#tmp_path=$(findmnt -o SOURCE / -rn)
#path_root=${tmp_path%[*}
#majmin=$(findmnt -nvr -o MAJ:MIN "$path_root")

#devpath=$(realpath "/sys/dev/block/$majmin")
#partition=$(cat "$devpath/partition")
#parent_path=$(dirname "$devpath")
#parent_device=/dev/$(basename "${parent_path}")

#growpart "${parent_device}" "${partition}" || true

installation_device=/dev/vda
partition=$(grep -c 'vda[0-9]' /proc/partitions)
growpart installation_device partition
echo "growpart executed on "$installation_device" "$partition" " 

crypt=$(lsblk -ln -o NAME,TYPE | grep crypt | awk '{print $1}')

if [[ -z ${crypt} ]]; then
    exit 1
fi
cryptsetup resize ${crypt}
echo "cryptsetup resize executed on "${crypt}" "

lvm pvresize /dev/mapper/${crypt}
lvm vgchange -ay rootvg


if [[ ! -e /dev/disk/by-label/root ]]; then
    dm=$(blkid --label root)
    if [[ -z ${dm} ]]; then
        exit 1
    fi
    ln -s ${dm} /dev/disk/by-label/root
fi
echo "mount root device at /growroot \n" 


path_root=/growroot
mkdir -p ${path_root}
mount -t xfs /dev/disk/by-label/root ${path_root}


# path_crypt=/grow_cryptroot
# mkdir -p ${path_crypt}
# device=$(blkid --label crypt_root)
# echo $device
# partition=$(cat "/sys/block/vda/vda4/partition")
# growpart /dev/vda 4


# get devic through coreos.inst

#lvextend +100%FREE (lvs- path of lv)
#tmp_path=$(findmnt -o SOURCE $path -rn)
#path_root=${tmp_path%[*}
#majmin=$(findmnt -nvr -o MAJ:MIN "$path")

#devpath=$(realpath "/sys/dev/block/$majmin")
#partition=$(cat "$devpath/partition")
#parent_path=$(dirname "$devpath")
#parent_device=/dev/$(basename "${parent_path}")
#growpart "${parent_device}" "${partition}" || true